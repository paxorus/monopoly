<!DOCTYPE html>
<html><head><title>Monopoly Game</title>
<link href="/stylesheets/shared.css" rel="stylesheet"></link>
<style>
/* One visual flaw of CSS animations is that they are not interruptible.
 * Hovering off the card while they are growing causes them to jump to scale(1.2)
 * before they shrink.
 */
@keyframes grow-summary-tile {
	from {transform: scale(1);}
	to {transform: scale(1.2); filter: brightness(1.05);}
}
@keyframes shrink-summary-tile {
	from {transform: scale(1.2);; filter: brightness(1.05);}
	to {transform: scale(1);}
}

#invalid-name-message {font-size: 12px; height: 15px}
.highlight-invalid-message {color: red}
#page-container {margin: 20px; margin-top: 30px;}
.text-input {padding: 5px; border: 3px #DDD solid; font-weight: bold;}

.link {text-decoration: none; color: black}
.game-summary-tile {
	float: left;
	padding: 10px;
	margin-right: 10px;
	margin-bottom: 10px;
	width: 250px;
	height: 200px;
	position: relative;
}
.game-summary-tile:hover {
	animation-name: grow-summary-tile;
	animation-duration: 0.5s;
	animation-fill-mode: forwards;
}
.game-summary-tile-shrunken {
	animation-name: shrink-summary-tile;
	animation-duration: 0.5s;
	animation-fill-mode: forwards;
}
.tile-overlay {
	position: absolute;
	top: 0;
	left: 0;
	width: inherit;
	height: inherit;
	pointer-events: none;
}
.player-donut-chart {padding-top: 10px; cursor: auto;}
</style>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.css" integrity="sha512-/zs32ZEJh+/EO2N1b0PEdoA10JkdC3zJ8L5FTiQu82LR9S/rOQNfQN7U59U9BC12swNeRAz3HSzIL2vpp4fv3w==" crossorigin="anonymous" />
</head>
<body>

<div id="page-container">
<h1>Welcome to Web Monopoly!</h1>

<input class="text-input" type="text" placeholder="Create a new game" />

<h2>In-Progress Games</h2>
<% if (inProgressGames.length > 0) { %>
	<% for (let i = 0; i < inProgressGames.length; i ++) { %>
		<% const game = inProgressGames[i]; %>
		<a href="/game/<%=game.id %>" class="link">
		<% if (game.hasStarted) { %>
			<!-- Display a tile, summarizing the game. -->
			<div class="game-summary-tile" style="background-color: #ccffd0">
				<b><%= game.name %></b>
				<div style="position: absolute; bottom: 15px">
					<div style="font-size: 12px">
						It's <%= (game.waitingOnName === game.yourName) ? "your" : `${game.waitingOnName}'s` %> move.
					</div>

					<% if (game.numTurns > 0) { %>
					<div style="font-size: 10px; color: #777">
						Last move <%= game.timeSinceUpdated %>.
					</div>
					<% } %>
					<div style="font-size: 12px"><%= game.numTurns %> turns &bull; <%= game.numOwnedProperties %> <%= game.numOwnedProperties === 1 ? "property" : "properties" %> sold</div>
					<div style="font-size: 10px; color: #777">Created <%= game.timeSinceCreated %> by <%= game.creatorName === game.yourName ? "you" : game.creatorName %></div>
				</div>
				<canvas class="player-donut-chart" id="player-performance-<%= game.id %>"></canvas>
				<div class="tile-overlay" style="display: none">
					Return to Game
				</div>
			</div>
		<% } else { %>
			<!-- Display a tile, summarizing the lobby. -->
			<div class="game-summary-tile" style="background-color: #d7e2f5">
				<b style="color: #777"><%= game.name %></b>
				<br />
				<ul style="font-size: 14px; padding-left: 30px">
					<% for (let j = 0; j < game.playerNames.length; j ++) { %>
						<% const playerName = game.playerNames[j]; %>
						<li><%= playerName %></li>
					<% } %>
				</ul>
				<br />
				<div style="position: absolute; bottom: 15px">
					<div style="font-size: 10px; color: #777">Created <%= game.timeSinceCreated %> by <%= game.creatorName === game.yourName ? "you" : game.creatorName %></div>
					<div style="font-size: 12px">In Lobby</div>
				</div>
				<div class="tile-overlay" style="display: none">
					Open Lobby
				</div>
			</div>			
		<% } %>
		</a>
	<% } %>
<% } else { %>
	<div>None</div>
<% } %>

<!-- Clear the floating. -->
<br style="clear: both" />

<h2>Completed Games</h2>
<% if (completedGames.length > 0) { %>
	<% for (let i = 0; i < completedGames.length; i ++) { %>
		<div>
			Admin: <%= completedGames[0].adminId %>
			<br />
			Game: <%= completedGames[0].name %>
			<br />
			Created: <%= new Date(completedGames[0].createTime) %>
		</div>
	<% } %>
<% } else { %>
	<div>None</div>
<% } %>

<!-- <form id="new-game-form" style="display: inline-block">
	<center>
	<h1>Create New Game</h1>
	Name: <input id="game-name-field" type="text" />
	<div id="invalid-name-message"></div>
	<div id="create-game" class="button button-disabled" style="display: inline-block;">Create</div>
	</center>
</form>
 --></div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js" integrity="sha512-d9xgZrVZpmmQlfonhQUvTR7lMPtO7NkZMkA0ABN3PHCbKA5nqylQ/yWlFAyY6hYgdF1Qh6nYiuADWwKB4C2WSw==" crossorigin="anonymous"></script>

<script src="/javascripts/third-party/jquery.js"></script>
<script src="/javascripts/landing/create-game.js"></script>

<script>
const inProgressGames = <%- JSON.stringify(inProgressGames) %>;
const completedGames = <%- JSON.stringify(completedGames) %>;
const startedGames = [...inProgressGames, ...completedGames].filter(game => game.hasStarted);

// Generate pie charts for each game to display player net worths.
startedGames.forEach(game => {
	const canvas = $(`#player-performance-${game.id}`)[0];
	// Clicking the canvas should not load the game page.
	canvas.addEventListener("click", event => event.preventDefault());
	const ctx = canvas.getContext("2d");
	const myChart = new Chart(ctx, {
		type: "doughnut",
		data: {
			labels: game.playerData.map(player => player.name),
			datasets: [{
				data: game.playerData.map(player => player.netWorth),
				backgroundColor: [
					"rgb(255, 99, 132)",
					"rgb(54, 162, 235)",
					"rgb(255, 206, 86)",
					"rgb(75, 192, 192)",
					"rgb(153, 102, 255)",
					"rgb(255, 159, 64)"
				],
				borderWidth: 0
			}]
		},
		options: {
			tooltips: {
				callbacks: {
					label: function(tooltipItem, {datasets, labels}) {
						const netWorth = datasets[tooltipItem.datasetIndex].data[tooltipItem.index];
						return `$${netWorth}`;
					}
				}
			},
			legend: {
				position: "left"
			}
		}
	});
});

// Activate the animation of the card shrinking back only after the page has loaded.
// This prevents the cards from an initial shrink on page load.
$(".game-summary-tile").on("animationstart", event => {
	$(event.target).toggleClass("game-summary-tile-shrunken", true);
});

// Display the text overlay while tile is in grown state.
$(".game-summary-tile").on("animationend", event => {
	if (event.originalEvent.animationName === "grow-summary-tile") {
		$(event.target).children(".tile-overlay").css("display", "block");
	}
});
$(".game-summary-tile").on("animationstart", event => {
	if (event.originalEvent.animationName === "shrink-summary-tile") {
		$(event.target).children(".tile-overlay").css("display", "none");
	}
});

// $(".player-donut-chart").on("hover", event => {
// 	event.stopPropagation();
// 	// event.
// 	return false;
// })
</script>
</body></html>